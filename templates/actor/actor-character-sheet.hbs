<form class="{{cssClass}} mech-foundry character-sheet" autocomplete="off">
  {{!-- Sheet Header - Personal Data --}}
  <header class="sheet-header">
    <div class="header-left">
      <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100"/>
    </div>
    <div class="header-center">
      <div class="personal-data-section">
        <h2 class="section-title">Personal Data</h2>
        <div class="personal-data-grid">
          <div class="field name-field">
            <label>Name</label>
            <input type="text" name="name" value="{{actor.name}}" placeholder="Character Name"/>
          </div>
          <div class="field">
            <label>Player</label>
            <input type="text" name="system.personalData.player" value="{{system.personalData.player}}"/>
          </div>
          <div class="field">
            <label>Height</label>
            <input type="text" name="system.personalData.height" value="{{system.personalData.height}}" placeholder="cm"/>
          </div>
          <div class="field">
            <label>Weight</label>
            <input type="text" name="system.personalData.weight" value="{{system.personalData.weight}}" placeholder="kg"/>
          </div>
          <div class="field">
            <label>Affiliation</label>
            <input type="text" name="system.affiliation" value="{{system.affiliation}}"/>
          </div>
          <div class="field">
            <label>Hair</label>
            <input type="text" name="system.personalData.hair" value="{{system.personalData.hair}}"/>
          </div>
          <div class="field">
            <label>Eyes</label>
            <input type="text" name="system.personalData.eyes" value="{{system.personalData.eyes}}"/>
          </div>
          <div class="field">
            <label>Extra</label>
            <input type="text" name="system.personalData.extra" value="{{system.personalData.extra}}"/>
          </div>
        </div>
      </div>
    </div>
  </header>

  {{!-- XP Display Bar (Always Visible) --}}
  <div class="xp-bar">
    <div class="xp-bar-item">
      <label>Available XP</label>
      <input type="number" name="system.xp.value" class="xp-input available" value="{{system.xp.value}}" data-dtype="Number" min="0"/>
    </div>
    <div class="xp-bar-item">
      <label>Spent XP</label>
      <span class="xp-value spent">{{system.xp.spent}}</span>
    </div>
    <div class="xp-bar-item">
      <label>Total XP</label>
      <span class="xp-value total">{{system.xp.total}}</span>
    </div>
  </div>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item" data-tab="attributes">Attributes</a>
    <a class="item" data-tab="skills">Skills</a>
    <a class="item" data-tab="traits">Traits</a>
    <a class="item" data-tab="combat">Combat</a>
    <a class="item" data-tab="inventory">Inventory</a>
    <a class="item" data-tab="conditions">Conditions</a>
    <a class="item" data-tab="biography">Biography</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Attributes Tab --}}
    <div class="tab attributes" data-group="primary" data-tab="attributes">
      <div class="attributes-section">
        <h3 class="section-title">Attributes</h3>
        <table class="attributes-table">
          <thead>
            <tr>
              <th>Attribute</th>
              <th>Score</th>
              <th>Mod</th>
              <th>Link</th>
              <th>XP Invested</th>
              <th>Next Rank</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr class="attribute-row" data-attribute="str">
              <td class="attribute-name">STR</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.str.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.str.modifier" value="{{system.attributes.str.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.str.linkMod 0)}}positive{{else if (lt system.attributes.str.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.str.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.str.xp}}" data-dtype="Number" data-attr="str" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.str}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="str" title="Roll STR (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="bod">
              <td class="attribute-name">BOD</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.bod.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.bod.modifier" value="{{system.attributes.bod.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.bod.linkMod 0)}}positive{{else if (lt system.attributes.bod.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.bod.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.bod.xp}}" data-dtype="Number" data-attr="bod" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.bod}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="bod" title="Roll BOD (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="rfl">
              <td class="attribute-name">RFL</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.rfl.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.rfl.modifier" value="{{system.attributes.rfl.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.rfl.linkMod 0)}}positive{{else if (lt system.attributes.rfl.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.rfl.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.rfl.xp}}" data-dtype="Number" data-attr="rfl" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.rfl}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="rfl" title="Roll RFL (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="dex">
              <td class="attribute-name">DEX</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.dex.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.dex.modifier" value="{{system.attributes.dex.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.dex.linkMod 0)}}positive{{else if (lt system.attributes.dex.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.dex.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.dex.xp}}" data-dtype="Number" data-attr="dex" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.dex}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="dex" title="Roll DEX (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="int">
              <td class="attribute-name">INT</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.int.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.int.modifier" value="{{system.attributes.int.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.int.linkMod 0)}}positive{{else if (lt system.attributes.int.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.int.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.int.xp}}" data-dtype="Number" data-attr="int" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.int}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="int" title="Roll INT (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="wil">
              <td class="attribute-name">WIL</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.wil.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.wil.modifier" value="{{system.attributes.wil.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.wil.linkMod 0)}}positive{{else if (lt system.attributes.wil.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.wil.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.wil.xp}}" data-dtype="Number" data-attr="wil" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.wil}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="wil" title="Roll WIL (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row" data-attribute="cha">
              <td class="attribute-name">CHA</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.cha.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.cha.modifier" value="{{system.attributes.cha.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link {{#if (gt system.attributes.cha.linkMod 0)}}positive{{else if (lt system.attributes.cha.linkMod 0)}}negative{{/if}}">
                {{formatMod system.attributes.cha.linkMod}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.cha.xp}}" data-dtype="Number" data-attr="cha" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.cha}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="attribute-roll" data-attribute="cha" title="Roll CHA (Shift+Click for Double)">
                  <i class="fas fa-dice-d6"></i>
                </button>
              </td>
            </tr>
            <tr class="attribute-row edge-row" data-attribute="edg">
              <td class="attribute-name">EDG</td>
              <td class="attribute-score">
                <span class="score-display">{{system.attributes.edg.total}}</span>
              </td>
              <td class="attribute-modifier">
                <input type="number" class="mod-input" name="system.attributes.edg.modifier" value="{{system.attributes.edg.modifier}}" data-dtype="Number"/>
              </td>
              <td class="attribute-link edge-current">
                {{system.attributes.edg.current}}
              </td>
              <td class="attribute-xp">
                <input type="number" class="xp-input attr-xp-input" value="{{system.attributes.edg.xp}}" data-dtype="Number" data-attr="edg" min="0"/>
              </td>
              <td class="attribute-next-cost">{{xpCosts.attributeNext.edg}} XP</td>
              <td class="attribute-roll-cell">
                <button type="button" class="burn-edge" title="Burn Edge">
                  <i class="fas fa-fire"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    {{!-- Skills Tab --}}
    <div class="tab skills" data-group="primary" data-tab="skills">
      <div class="skills-section">
        <div class="items-header">
          <h3 class="section-title">Skills</h3>
          <a class="item-create" data-type="skill"><i class="fas fa-plus"></i> Add Skill</a>
        </div>
        <table class="skills-table">
          <thead>
            <tr>
              <th>Skill</th>
              <th>Total Mod</th>
              <th>Level</th>
              <th>Links</th>
              <th>TN/C</th>
              <th>XP Invested</th>
              <th>Next Level</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each skills}}
            <tr class="item skill-row" data-item-id="{{this._id}}">
              <td class="skill-name">
                <a class="skill-roll" title="Click to roll">
                  <i class="fas fa-dice"></i> {{this.name}}
                </a>
              </td>
              <td class="skill-total-mod">{{formatMod this.effectiveLevel}}</td>
              <td class="skill-level">{{formatMod this.system.level}}</td>
              <td class="skill-links">
                {{this.system.linkedAttribute1}}{{#if this.system.linkedAttribute2}}+{{this.system.linkedAttribute2}}{{/if}}
                ({{formatMod this.totalLinkMod}})
              </td>
              <td class="skill-tn">{{this.system.targetNumber}}/{{this.system.complexity}}</td>
              <td class="skill-xp">
                <input type="number" class="xp-input skill-xp-input" value="{{this.system.xp}}" data-item-id="{{this._id}}" data-dtype="Number" min="0"/>
              </td>
              <td class="skill-next-cost">{{this.nextLevelCost}} XP</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>

    {{!-- Traits Tab --}}
    <div class="tab traits" data-group="primary" data-tab="traits">
      <div class="traits-section">
        <div class="items-header">
          <h3 class="section-title">Traits (Personal)</h3>
          <a class="item-create" data-type="trait"><i class="fas fa-plus"></i> Add Trait</a>
        </div>
        <table class="traits-table">
          <thead>
            <tr>
              <th>Trait</th>
              <th>TP</th>
              <th>Page Ref.</th>
              <th>XP Cost</th>
              <th>XP Invested</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each traits}}
            <tr class="item trait-row {{this.system.traitType}}" data-item-id="{{this._id}}">
              <td class="trait-name">
                <span class="trait-indicator">{{#if (eq this.system.traitType "positive")}}+{{else}}-{{/if}}</span>
                {{this.name}}
              </td>
              <td class="trait-cost">{{this.system.cost}}</td>
              <td class="trait-pageref">{{this.system.pageRef}}</td>
              <td class="trait-xpcost">{{this.xpCost}}</td>
              <td class="trait-xp">
                <input type="number" class="xp-input trait-xp-input" value="{{this.system.xp}}" data-item-id="{{this._id}}" data-xp-cost="{{this.xpCost}}" data-dtype="Number" min="0"/>
                {{#if this.system.purchased}}
                <span class="purchased"><i class="fas fa-check"></i></span>
                {{/if}}
              </td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
    </div>

    {{!-- Combat Tab --}}
    <div class="tab combat" data-group="primary" data-tab="combat">
      <div class="combat-layout">
        {{!-- Left Column: Condition Monitor --}}
        <div class="combat-column condition-column">
          <div class="combat-data-section">
            <h3 class="section-title">Condition Monitor</h3>

            {{!-- Standard Damage Track --}}
            <div class="condition-track damage-track">
              <label>Standard Damage</label>
              <div class="condition-boxes">
                {{#times system.damageCapacity}}
                <span class="condition-box {{#if (lt this @root.system.damage.value)}}filled{{/if}}" data-index="{{this}}" data-type="damage"></span>
                {{/times}}
              </div>
              <input type="number" class="condition-input" name="system.damage.value" value="{{system.damage.value}}" min="0" max="{{system.damageCapacity}}" data-dtype="Number" data-max="{{system.damageCapacity}}"/>
            </div>

            {{!-- Fatigue Track --}}
            <div class="condition-track fatigue-track">
              <label>Fatigue Damage</label>
              <div class="condition-boxes">
                {{#times system.fatigueCapacity}}
                <span class="condition-box {{#if (lt this @root.system.fatigue.value)}}filled{{/if}}" data-index="{{this}}" data-type="fatigue"></span>
                {{/times}}
              </div>
              <input type="number" class="condition-input" name="system.fatigue.value" value="{{system.fatigue.value}}" min="0" max="{{system.fatigueCapacity}}" data-dtype="Number" data-max="{{system.fatigueCapacity}}"/>
            </div>

            {{!-- Status Checkboxes --}}
            <div class="status-row">
              <label class="status-checkbox">
                <input type="checkbox" name="system.stun" {{#if system.stun}}checked{{/if}}/>
                Stun
              </label>
              <label class="status-checkbox">
                <input type="checkbox" name="system.unconscious" {{#if system.unconscious}}checked{{/if}}/>
                Unconscious
              </label>
            </div>

            {{!-- Condition Modifiers --}}
            <div class="condition-modifiers">
              {{#if (lt system.injuryModifier 0)}}
              <span class="modifier injury">Injury: {{system.injuryModifier}}</span>
              {{/if}}
              {{#if (lt system.fatigueModifier 0)}}
              <span class="modifier fatigue">Fatigue: {{system.fatigueModifier}}</span>
              {{/if}}
            </div>

            {{!-- Action Buttons --}}
            <div class="condition-actions">
              <button type="button" class="recover-fatigue" title="Recover Fatigue (Complex Action)">
                <i class="fas fa-heart"></i> Recover Fatigue
              </button>
              <button type="button" class="clear-stun" title="Clear Stun (Simple Action)">
                <i class="fas fa-bolt"></i> Clear Stun
              </button>
              <button type="button" class="consciousness-check" title="Consciousness Check (TN 7)">
                <i class="fas fa-brain"></i> Consciousness
              </button>
            </div>
          </div>

          {{!-- Movement Section --}}
          <div class="movement-section">
            <h3 class="section-title">Movement (Meters per Turn)</h3>
            <div class="movement-grid">
              <div class="movement-item">
                <label>Walk</label>
                <span class="movement-value">{{system.movement.walk}}</span>
              </div>
              <div class="movement-item">
                <label>Climb</label>
                <span class="movement-value">{{system.movement.climb}}</span>
              </div>
              <div class="movement-item">
                <label>Run/Evade</label>
                <span class="movement-value">{{system.movement.run}}</span>
              </div>
              <div class="movement-item">
                <label>Crawl</label>
                <span class="movement-value">{{system.movement.crawl}}</span>
              </div>
              <div class="movement-item">
                <label>Sprint</label>
                <span class="movement-value">{{system.movement.sprint}}</span>
              </div>
              <div class="movement-item">
                <label>Swim</label>
                <span class="movement-value">{{system.movement.swim}}</span>
              </div>
            </div>
          </div>
        </div>

        {{!-- Right Column: Armor & Weapons --}}
        <div class="combat-column equipment-column">
          {{!-- Personal Armor Section --}}
          <div class="armor-section">
            <div class="items-header">
              <h3 class="section-title">Personal Armor (Equipped)</h3>
              <a class="item-create" data-type="armor"><i class="fas fa-plus"></i></a>
            </div>

            {{!-- Total Armor Display --}}
            <div class="total-armor-display">
              <table class="total-armor-table">
                <thead>
                  <tr>
                    <th>Location</th>
                    <th>M</th>
                    <th>B</th>
                    <th>E</th>
                    <th>X</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>Head</td>
                    <td>{{totalArmor.head.m}}</td>
                    <td>{{totalArmor.head.b}}</td>
                    <td>{{totalArmor.head.e}}</td>
                    <td>{{totalArmor.head.x}}</td>
                  </tr>
                  <tr>
                    <td>Torso</td>
                    <td>{{totalArmor.torso.m}}</td>
                    <td>{{totalArmor.torso.b}}</td>
                    <td>{{totalArmor.torso.e}}</td>
                    <td>{{totalArmor.torso.x}}</td>
                  </tr>
                  <tr>
                    <td>Arms</td>
                    <td>{{totalArmor.arms.m}}</td>
                    <td>{{totalArmor.arms.b}}</td>
                    <td>{{totalArmor.arms.e}}</td>
                    <td>{{totalArmor.arms.x}}</td>
                  </tr>
                  <tr>
                    <td>Legs</td>
                    <td>{{totalArmor.legs.m}}</td>
                    <td>{{totalArmor.legs.b}}</td>
                    <td>{{totalArmor.legs.e}}</td>
                    <td>{{totalArmor.legs.x}}</td>
                  </tr>
                </tbody>
              </table>
            </div>

            {{#if equippedArmor.length}}
            <table class="armor-table equipped-armor-table">
              <thead>
                <tr>
                  <th>Armor Type</th>
                  <th>Coverage</th>
                  <th colspan="4">BAR (M/B/E/X)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {{#each equippedArmor}}
                <tr class="item" data-item-id="{{this._id}}">
                  <td class="armor-type">{{this.name}}</td>
                  <td class="armor-coverage">
                    {{#if this.system.coverage.head}}H{{/if}}{{#if this.system.coverage.torso}}T{{/if}}{{#if this.system.coverage.arms}}A{{/if}}{{#if this.system.coverage.legs}}L{{/if}}
                  </td>
                  <td class="armor-bar">{{this.system.bar.m}}</td>
                  <td class="armor-bar">{{this.system.bar.b}}</td>
                  <td class="armor-bar">{{this.system.bar.e}}</td>
                  <td class="armor-bar">{{this.system.bar.x}}</td>
                  <td class="item-controls">
                    <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
            {{else}}
            <p class="no-equipped-items">No armor equipped. Equip armor from the Inventory tab.</p>
            {{/if}}
          </div>

          {{!-- Weapons Section --}}
          <div class="weapons-section">
            <div class="items-header">
              <h3 class="section-title">Weapons (Equipped)</h3>
              <a class="item-create" data-type="weapon"><i class="fas fa-plus"></i></a>
            </div>
            {{#if equippedWeapons.length}}
            <table class="weapons-table equipped-weapons-table">
              <thead>
                <tr>
                  <th>Weapon</th>
                  <th>Skill</th>
                  <th>AP/BD</th>
                  <th>Range</th>
                  <th>Ammo</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {{#each equippedWeapons}}
                <tr class="item" data-item-id="{{this._id}}">
                  <td class="weapon-name">
                    <a class="weapon-attack-roll" title="Click to attack">{{this.name}}</a>
                  </td>
                  <td class="weapon-skill">{{this.system.skill}}</td>
                  <td class="weapon-apbd">{{this.system.ap}}{{this.system.apFactor}}/{{this.system.bd}}{{this.system.bdFactor}}</td>
                  <td class="weapon-range">
                    {{#if (eq this.system.weaponType "melee")}}Melee{{else}}{{this.system.range.short}}/{{this.system.range.medium}}/{{this.system.range.long}}{{/if}}
                  </td>
                  <td class="weapon-ammo">
                    {{#if this.system.ammo.max}}
                      {{this.system.ammo.value}}/{{this.system.ammo.max}}
                      {{#if (ne this.system.weaponType "melee")}}<a class="weapon-reload" data-item-id="{{this._id}}" title="Reload"><i class="fas fa-redo"></i></a>{{/if}}
                    {{else}}—{{/if}}
                  </td>
                  <td class="item-controls">
                    <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
            {{else}}
            <p class="no-equipped-items">No weapons equipped. Equip weapons from the Inventory tab.</p>
            {{/if}}
          </div>
        </div>
      </div>
    </div>

    {{!-- Inventory Tab --}}
    <div class="tab inventory" data-group="primary" data-tab="inventory">
      {{!-- C-Bills and Weight Bar --}}
      <div class="inventory-header-bar">
        <div class="cbills-section">
          <label>C-Bills</label>
          <input type="number" name="system.cbills" value="{{system.cbills}}" data-dtype="Number" min="0"/>
        </div>
        <div class="weight-section">
          <label>Carried Weight</label>
          <span class="weight-value">{{inventory.totalWeight}} kg</span>
        </div>
        <div class="encumbrance-section">
          <span class="encumbrance-status {{inventory.encumbrance.level}}">{{inventory.encumbrance.label}}</span>
          {{#if inventory.encumbrance.effects}}
          <span class="encumbrance-effects">{{inventory.encumbrance.effects}}</span>
          {{/if}}
        </div>
        <div class="add-item-section">
          <button type="button" class="add-inventory-item"><i class="fas fa-plus"></i> Add Item</button>
        </div>
      </div>

      {{!-- Armor Category --}}
      {{#if inventory.armor.length}}
      <div class="inventory-category armor-category">
        <h3 class="section-title">Armor</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>BAR (M/B/E/X)</th>
              <th>Coverage</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.armor}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "equipped")}}<i class="fas fa-shield-alt"></i>{{else if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="armor-bar">{{this.system.bar.m}}/{{this.system.bar.b}}/{{this.system.bar.e}}/{{this.system.bar.x}}</td>
              <td class="armor-coverage">
                {{#if this.system.coverage.head}}Head{{/if}}{{#if (and this.system.coverage.head (or this.system.coverage.torso this.system.coverage.arms this.system.coverage.legs))}}, {{/if}}{{#if this.system.coverage.torso}}Torso{{/if}}{{#if (and this.system.coverage.torso (or this.system.coverage.arms this.system.coverage.legs))}}, {{/if}}{{#if this.system.coverage.arms}}Arms{{/if}}{{#if (and this.system.coverage.arms this.system.coverage.legs)}}, {{/if}}{{#if this.system.coverage.legs}}Legs{{/if}}
              </td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Weapons Category --}}
      {{#if inventory.weapons.length}}
      <div class="inventory-category weapons-category">
        <h3 class="section-title">Weapons</h3>
        <table class="inventory-table centered-data">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Skill</th>
              <th>AP/BD</th>
              <th>Range (PB/S/M/L/E)</th>
              <th>Ammo</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.weapons}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "equipped")}}<i class="fas fa-hand-rock"></i>{{else if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">
                {{#if (eq this.system.carryStatus "equipped")}}<a class="weapon-attack-roll" title="Click to attack">{{this.name}}</a>{{else}}{{this.name}}{{/if}}
              </td>
              <td class="weapon-skill">{{this.system.skill}}</td>
              <td class="weapon-apbd">{{this.system.ap}}{{this.system.apFactor}}/{{this.system.bd}}{{this.system.bdFactor}}</td>
              <td class="weapon-range">
                {{#if (eq this.system.weaponType "melee")}}Melee{{else}}{{this.system.range.pointBlank}}/{{this.system.range.short}}/{{this.system.range.medium}}/{{this.system.range.long}}/{{this.system.range.extreme}}{{/if}}
              </td>
              <td class="weapon-ammo">
                {{#if this.system.ammo.max}}
                  {{this.system.ammo.value}}/{{this.system.ammo.max}}
                  {{#if (ne this.system.weaponType "melee")}}<a class="weapon-reload" data-item-id="{{this._id}}" title="Reload"><i class="fas fa-redo"></i></a>{{/if}}
                {{else}}—{{/if}}
              </td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Electronics Category --}}
      {{#if inventory.electronics.length}}
      <div class="inventory-category electronics-category">
        <h3 class="section-title">Electronics</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Range</th>
              <th>Power</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.electronics}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="item-range">{{this.system.range}}</td>
              <td class="item-power">{{this.system.powerUse}}</td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Power Packs Category --}}
      {{#if inventory.powerpacks.length}}
      <div class="inventory-category powerpacks-category">
        <h3 class="section-title">Power Packs</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Capacity</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.powerpacks}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="item-capacity">{{this.system.powerCapacity}}</td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Health Care Category --}}
      {{#if inventory.healthcare.length}}
      <div class="inventory-category healthcare-category">
        <h3 class="section-title">Health Care</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Power</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.healthcare}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="item-power">{{this.system.powerUse}}</td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Prosthetics Category --}}
      {{#if inventory.prosthetics.length}}
      <div class="inventory-category prosthetics-category">
        <h3 class="section-title">Prosthetics</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.prosthetics}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="item-notes">{{this.system.notes}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Drugs & Poisons Category --}}
      {{#if inventory.drugpoisons.length}}
      <div class="inventory-category drugpoisons-category">
        <h3 class="section-title">Drugs & Poisons</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Strength/AP</th>
              <th>Duration</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.drugpoisons}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="item-strength">{{this.system.drugStrength}}/{{this.system.poisonAP}}</td>
              <td class="item-duration">{{this.system.duration}}</td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Personal Vehicles Category --}}
      {{#if inventory.vehicles.length}}
      <div class="inventory-category vehicles-category">
        <h3 class="section-title">Personal Vehicles</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Type</th>
              <th>Speed</th>
              <th>Range</th>
              <th>Crew/Pass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.vehicles}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="vehicle-type">{{this.system.vehicleType}}</td>
              <td class="vehicle-speed">{{this.system.speed}}</td>
              <td class="vehicle-range">{{this.system.range}}</td>
              <td class="vehicle-crew">{{this.system.crew}}/{{this.system.passengers}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Fuel Category --}}
      {{#if inventory.fuel.length}}
      <div class="inventory-category fuel-category">
        <h3 class="section-title">Fuel</h3>
        <table class="inventory-table">
          <thead>
            <tr>
              <th class="status-col"></th>
              <th>Name</th>
              <th>Type</th>
              <th>Mass</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {{#each inventory.fuel}}
            <tr class="item" data-item-id="{{this._id}}">
              <td class="item-status">
                <a class="carry-status-toggle" data-status="{{this.system.carryStatus}}" title="{{this.system.carryStatus}}">
                  {{#if (eq this.system.carryStatus "carried")}}<i class="fas fa-suitcase"></i>{{else}}<i class="fas fa-warehouse"></i>{{/if}}
                </a>
              </td>
              <td class="item-name">{{this.name}}</td>
              <td class="fuel-type">{{this.system.fuelType}}</td>
              <td class="item-mass">{{this.system.mass}}</td>
              <td class="item-controls">
                <a class="item-edit" title="Edit"><i class="fas fa-edit"></i></a>
                <a class="item-delete" title="Delete"><i class="fas fa-trash"></i></a>
              </td>
            </tr>
            {{/each}}
          </tbody>
        </table>
      </div>
      {{/if}}

      {{!-- Empty inventory message --}}
      {{#unless inventory.hasItems}}
      <div class="inventory-empty">
        <p>No items in inventory. Click "Add Item" or drag items here to add them.</p>
      </div>
      {{/unless}}
    </div>

    {{!-- Conditions Tab --}}
    <div class="tab conditions" data-group="primary" data-tab="conditions">
      <div class="conditions-section">
        <div class="section-header">
          <h3 class="section-title">Active Effects</h3>
        </div>

        <div class="active-effects-list">
          {{#if activeEffects.length}}
          <table class="effects-table">
            <thead>
              <tr>
                <th class="effect-active">Active</th>
                <th class="effect-name">Name</th>
                <th class="effect-type">Type</th>
                <th class="effect-details">Details</th>
                <th class="effect-controls">Controls</th>
              </tr>
            </thead>
            <tbody>
              {{#each activeEffects}}
              <tr class="item effect-row {{#unless this.system.active}}inactive{{/unless}}" data-item-id="{{this._id}}">
                <td class="effect-active">
                  <input type="checkbox" class="effect-toggle" data-item-id="{{this._id}}" {{#if this.system.active}}checked{{/if}} title="Toggle Active"/>
                </td>
                <td class="effect-name">
                  <img class="effect-img" src="{{this.img}}" width="24" height="24"/>
                  <span>{{this.name}}</span>
                </td>
                <td class="effect-type">
                  {{#if (eq this.system.effectType "continuous_damage")}}
                  <span class="tag damage-tag">Continuous Damage</span>
                  {{else}}
                  <span class="tag persistent-tag">Persistent</span>
                  {{/if}}
                </td>
                <td class="effect-details">
                  {{#if (eq this.system.effectType "continuous_damage")}}
                  <span class="damage-info">
                    {{#if this.system.continuousDamage}}
                      {{#if this.system.continuousDamage.standardDamage}}Std: {{this.system.continuousDamage.standardDamage}}{{/if}}
                      {{#if this.system.continuousDamage.fatigueDamage}}Fat: {{this.system.continuousDamage.fatigueDamage}}{{/if}}
                    {{/if}}
                  </span>
                  {{else}}
                  <span class="modifier-count">{{#if this.system.persistentModifiers}}{{this.system.persistentModifiers.length}}{{else}}0{{/if}} modifier(s)</span>
                  {{/if}}
                </td>
                <td class="effect-controls">
                  <a class="item-edit" data-item-id="{{this._id}}" title="Edit"><i class="fas fa-edit"></i></a>
                  <a class="item-delete" data-item-id="{{this._id}}" title="Delete"><i class="fas fa-trash"></i></a>
                </td>
              </tr>
              {{/each}}
            </tbody>
          </table>
          {{else}}
          <p class="no-effects">No active effects. Click "Add Effect" or drag an Active Effect item here.</p>
          {{/if}}
        </div>

        {{!-- Summary of Active Modifiers --}}
        {{#if hasActiveModifiers}}
        <div class="active-modifiers-summary">
          <h4>Current Active Modifiers</h4>
          <ul class="modifier-summary-list">
            {{#each activeModifiersSummary}}
            <li>
              <span class="modifier-target">{{this.target}}</span>
              <span class="modifier-value {{#if this.isMultiplicative}}multiplicative{{else if (lt this.value 0)}}negative{{else}}positive{{/if}}">
                {{#if this.isMultiplicative}}×{{this.value}}{{else}}{{formatMod this.value}}{{/if}}
              </span>
              <span class="modifier-source">({{this.source}})</span>
            </li>
            {{/each}}
          </ul>
        </div>
        {{/if}}
      </div>
    </div>

    {{!-- Biography Tab --}}
    <div class="tab biography" data-group="primary" data-tab="biography">
      {{!-- Phenotype Row --}}
      <div class="bio-header-row">
        <div class="form-group">
          <label>Phenotype</label>
          <select class="phenotype-select" name="system.phenotype">
            {{#each config.phenotypes as |phenotype key|}}
            <option value="{{key}}" {{#if (eq key ../system.phenotype)}}selected{{/if}}>{{phenotype.label}}</option>
            {{/each}}
          </select>
        </div>
      </div>

      {{!-- Languages Section --}}
      <div class="languages-section">
        <div class="section-header">
          <h3 class="section-title">Languages</h3>
          <a class="add-language" title="Add Language"><i class="fas fa-plus"></i></a>
        </div>
        <div class="languages-list">
          {{#each lifeStagesData.languages as |lang langId|}}
          <div class="language-row" data-lang-id="{{langId}}">
            <select name="system.languages.{{langId}}.type">
              <option value="primary" {{#if (eq lang.type "primary")}}selected{{/if}}>Primary</option>
              <option value="secondary" {{#if (eq lang.type "secondary")}}selected{{/if}}>Secondary</option>
            </select>
            <input type="text" name="system.languages.{{langId}}.name" value="{{lang.name}}" placeholder="Language name"/>
            <a class="remove-language" data-lang-id="{{langId}}" title="Remove"><i class="fas fa-trash"></i></a>
          </div>
          {{else}}
          <p class="no-languages">No languages added. Click + to add one.</p>
          {{/each}}
        </div>
      </div>

      {{!-- Life Stages Grid --}}
      <div class="life-stages-grid">
        {{!-- Stage 0: Affiliation --}}
        <div class="life-stage-panel" data-stage="stage0">
          <div class="stage-header">
            <h3 class="section-title">Stage 0: Affiliation</h3>
          </div>
          <div class="module-subpanels">
            {{#each lifeStagesData.stage0.modules as |mod modId|}}
            <div class="module-subpanel" data-module-id="{{modId}}">
              <div class="subpanel-header">
                <input type="text" name="system.lifeStages.stage0.modules.{{modId}}.name" value="{{mod.name}}" placeholder="Module Name" class="module-name-input"/>
              </div>
              <div class="subpanel-xp">
                <label>XP Cost</label>
                <input type="number" name="system.lifeStages.stage0.modules.{{modId}}.xpCost" value="{{mod.xpCost}}" data-dtype="Number" min="0"/>
              </div>
              <div class="subpanel-columns">
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Attributes</label>
                    <a class="add-entry" data-stage="stage0" data-module="{{modId}}" data-type="attributes"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.attributes as |attr attrId|}}
                    <div class="entry-row" data-entry-id="{{attrId}}">
                      <input type="text" name="system.lifeStages.stage0.modules.{{modId}}.attributes.{{attrId}}.value" value="{{attr.value}}" placeholder="e.g., STR +1"/>
                      <a class="remove-entry" data-stage="stage0" data-module="{{modId}}" data-type="attributes" data-entry="{{attrId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Skills</label>
                    <a class="add-entry" data-stage="stage0" data-module="{{modId}}" data-type="skills"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.skills as |skill skillId|}}
                    <div class="entry-row" data-entry-id="{{skillId}}">
                      <input type="text" name="system.lifeStages.stage0.modules.{{modId}}.skills.{{skillId}}.value" value="{{skill.value}}" placeholder="e.g., Computers +2"/>
                      <a class="remove-entry" data-stage="stage0" data-module="{{modId}}" data-type="skills" data-entry="{{skillId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Traits</label>
                    <a class="add-entry" data-stage="stage0" data-module="{{modId}}" data-type="traits"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.traits as |trait traitId|}}
                    <div class="entry-row" data-entry-id="{{traitId}}">
                      <input type="text" name="system.lifeStages.stage0.modules.{{modId}}.traits.{{traitId}}.value" value="{{trait.value}}" placeholder="e.g., Fast Learner"/>
                      <a class="remove-entry" data-stage="stage0" data-module="{{modId}}" data-type="traits" data-entry="{{traitId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            {{else}}
            <div class="module-subpanel empty-module">
              <p class="empty-message">No module data. Enter details above.</p>
            </div>
            {{/each}}
          </div>
        </div>

        {{!-- Stage 1: Early Childhood --}}
        <div class="life-stage-panel" data-stage="stage1">
          <div class="stage-header">
            <h3 class="section-title">Stage 1: Early Childhood</h3>
          </div>
          <div class="module-subpanels">
            {{#each lifeStagesData.stage1.modules as |mod modId|}}
            <div class="module-subpanel" data-module-id="{{modId}}">
              <div class="subpanel-header">
                <input type="text" name="system.lifeStages.stage1.modules.{{modId}}.name" value="{{mod.name}}" placeholder="Module Name" class="module-name-input"/>
              </div>
              <div class="subpanel-xp">
                <label>XP Cost</label>
                <input type="number" name="system.lifeStages.stage1.modules.{{modId}}.xpCost" value="{{mod.xpCost}}" data-dtype="Number" min="0"/>
              </div>
              <div class="subpanel-columns">
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Attributes</label>
                    <a class="add-entry" data-stage="stage1" data-module="{{modId}}" data-type="attributes"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.attributes as |attr attrId|}}
                    <div class="entry-row" data-entry-id="{{attrId}}">
                      <input type="text" name="system.lifeStages.stage1.modules.{{modId}}.attributes.{{attrId}}.value" value="{{attr.value}}" placeholder="e.g., STR +1"/>
                      <a class="remove-entry" data-stage="stage1" data-module="{{modId}}" data-type="attributes" data-entry="{{attrId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Skills</label>
                    <a class="add-entry" data-stage="stage1" data-module="{{modId}}" data-type="skills"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.skills as |skill skillId|}}
                    <div class="entry-row" data-entry-id="{{skillId}}">
                      <input type="text" name="system.lifeStages.stage1.modules.{{modId}}.skills.{{skillId}}.value" value="{{skill.value}}" placeholder="e.g., Computers +2"/>
                      <a class="remove-entry" data-stage="stage1" data-module="{{modId}}" data-type="skills" data-entry="{{skillId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Traits</label>
                    <a class="add-entry" data-stage="stage1" data-module="{{modId}}" data-type="traits"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.traits as |trait traitId|}}
                    <div class="entry-row" data-entry-id="{{traitId}}">
                      <input type="text" name="system.lifeStages.stage1.modules.{{modId}}.traits.{{traitId}}.value" value="{{trait.value}}" placeholder="e.g., Fast Learner"/>
                      <a class="remove-entry" data-stage="stage1" data-module="{{modId}}" data-type="traits" data-entry="{{traitId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            {{else}}
            <div class="module-subpanel empty-module">
              <p class="empty-message">No module data. Enter details above.</p>
            </div>
            {{/each}}
          </div>
        </div>

        {{!-- Stage 2: Late Childhood --}}
        <div class="life-stage-panel" data-stage="stage2">
          <div class="stage-header">
            <h3 class="section-title">Stage 2: Late Childhood</h3>
          </div>
          <div class="module-subpanels">
            {{#each lifeStagesData.stage2.modules as |mod modId|}}
            <div class="module-subpanel" data-module-id="{{modId}}">
              <div class="subpanel-header">
                <input type="text" name="system.lifeStages.stage2.modules.{{modId}}.name" value="{{mod.name}}" placeholder="Module Name" class="module-name-input"/>
              </div>
              <div class="subpanel-xp">
                <label>XP Cost</label>
                <input type="number" name="system.lifeStages.stage2.modules.{{modId}}.xpCost" value="{{mod.xpCost}}" data-dtype="Number" min="0"/>
              </div>
              <div class="subpanel-columns">
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Attributes</label>
                    <a class="add-entry" data-stage="stage2" data-module="{{modId}}" data-type="attributes"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.attributes as |attr attrId|}}
                    <div class="entry-row" data-entry-id="{{attrId}}">
                      <input type="text" name="system.lifeStages.stage2.modules.{{modId}}.attributes.{{attrId}}.value" value="{{attr.value}}" placeholder="e.g., STR +1"/>
                      <a class="remove-entry" data-stage="stage2" data-module="{{modId}}" data-type="attributes" data-entry="{{attrId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Skills</label>
                    <a class="add-entry" data-stage="stage2" data-module="{{modId}}" data-type="skills"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.skills as |skill skillId|}}
                    <div class="entry-row" data-entry-id="{{skillId}}">
                      <input type="text" name="system.lifeStages.stage2.modules.{{modId}}.skills.{{skillId}}.value" value="{{skill.value}}" placeholder="e.g., Computers +2"/>
                      <a class="remove-entry" data-stage="stage2" data-module="{{modId}}" data-type="skills" data-entry="{{skillId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Traits</label>
                    <a class="add-entry" data-stage="stage2" data-module="{{modId}}" data-type="traits"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.traits as |trait traitId|}}
                    <div class="entry-row" data-entry-id="{{traitId}}">
                      <input type="text" name="system.lifeStages.stage2.modules.{{modId}}.traits.{{traitId}}.value" value="{{trait.value}}" placeholder="e.g., Fast Learner"/>
                      <a class="remove-entry" data-stage="stage2" data-module="{{modId}}" data-type="traits" data-entry="{{traitId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            {{else}}
            <div class="module-subpanel empty-module">
              <p class="empty-message">No module data. Enter details above.</p>
            </div>
            {{/each}}
          </div>
        </div>

        {{!-- Stage 3: Higher Education --}}
        <div class="life-stage-panel" data-stage="stage3">
          <div class="stage-header">
            <h3 class="section-title">Stage 3: Higher Education</h3>
            <a class="add-module" data-stage="stage3" title="Add Module"><i class="fas fa-plus"></i></a>
          </div>
          <div class="module-subpanels">
            {{#each lifeStagesData.stage3.modules as |mod modId|}}
            <div class="module-subpanel" data-module-id="{{modId}}">
              <div class="subpanel-header">
                <input type="text" name="system.lifeStages.stage3.modules.{{modId}}.name" value="{{mod.name}}" placeholder="Module Name" class="module-name-input"/>
                <a class="remove-module" data-stage="stage3" data-module-id="{{modId}}" title="Remove Module"><i class="fas fa-trash"></i></a>
              </div>
              <div class="subpanel-xp">
                <label>XP Cost</label>
                <input type="number" name="system.lifeStages.stage3.modules.{{modId}}.xpCost" value="{{mod.xpCost}}" data-dtype="Number" min="0"/>
              </div>
              <div class="subpanel-columns">
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Attributes</label>
                    <a class="add-entry" data-stage="stage3" data-module="{{modId}}" data-type="attributes"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.attributes as |attr attrId|}}
                    <div class="entry-row" data-entry-id="{{attrId}}">
                      <input type="text" name="system.lifeStages.stage3.modules.{{modId}}.attributes.{{attrId}}.value" value="{{attr.value}}" placeholder="e.g., STR +1"/>
                      <a class="remove-entry" data-stage="stage3" data-module="{{modId}}" data-type="attributes" data-entry="{{attrId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Skills</label>
                    <a class="add-entry" data-stage="stage3" data-module="{{modId}}" data-type="skills"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.skills as |skill skillId|}}
                    <div class="entry-row" data-entry-id="{{skillId}}">
                      <input type="text" name="system.lifeStages.stage3.modules.{{modId}}.skills.{{skillId}}.value" value="{{skill.value}}" placeholder="e.g., Computers +2"/>
                      <a class="remove-entry" data-stage="stage3" data-module="{{modId}}" data-type="skills" data-entry="{{skillId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Traits</label>
                    <a class="add-entry" data-stage="stage3" data-module="{{modId}}" data-type="traits"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.traits as |trait traitId|}}
                    <div class="entry-row" data-entry-id="{{traitId}}">
                      <input type="text" name="system.lifeStages.stage3.modules.{{modId}}.traits.{{traitId}}.value" value="{{trait.value}}" placeholder="e.g., Fast Learner"/>
                      <a class="remove-entry" data-stage="stage3" data-module="{{modId}}" data-type="traits" data-entry="{{traitId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            {{else}}
            <div class="module-subpanel empty-module">
              <p class="empty-message">No modules added. Click + to add one.</p>
            </div>
            {{/each}}
          </div>
        </div>

        {{!-- Stage 4: Real Life --}}
        <div class="life-stage-panel" data-stage="stage4">
          <div class="stage-header">
            <h3 class="section-title">Stage 4: Real Life</h3>
            <a class="add-module" data-stage="stage4" title="Add Module"><i class="fas fa-plus"></i></a>
          </div>
          <div class="module-subpanels">
            {{#each lifeStagesData.stage4.modules as |mod modId|}}
            <div class="module-subpanel" data-module-id="{{modId}}">
              <div class="subpanel-header">
                <input type="text" name="system.lifeStages.stage4.modules.{{modId}}.name" value="{{mod.name}}" placeholder="Module Name" class="module-name-input"/>
                <a class="remove-module" data-stage="stage4" data-module-id="{{modId}}" title="Remove Module"><i class="fas fa-trash"></i></a>
              </div>
              <div class="subpanel-xp">
                <label>XP Cost</label>
                <input type="number" name="system.lifeStages.stage4.modules.{{modId}}.xpCost" value="{{mod.xpCost}}" data-dtype="Number" min="0"/>
              </div>
              <div class="subpanel-columns">
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Attributes</label>
                    <a class="add-entry" data-stage="stage4" data-module="{{modId}}" data-type="attributes"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.attributes as |attr attrId|}}
                    <div class="entry-row" data-entry-id="{{attrId}}">
                      <input type="text" name="system.lifeStages.stage4.modules.{{modId}}.attributes.{{attrId}}.value" value="{{attr.value}}" placeholder="e.g., STR +1"/>
                      <a class="remove-entry" data-stage="stage4" data-module="{{modId}}" data-type="attributes" data-entry="{{attrId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Skills</label>
                    <a class="add-entry" data-stage="stage4" data-module="{{modId}}" data-type="skills"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.skills as |skill skillId|}}
                    <div class="entry-row" data-entry-id="{{skillId}}">
                      <input type="text" name="system.lifeStages.stage4.modules.{{modId}}.skills.{{skillId}}.value" value="{{skill.value}}" placeholder="e.g., Computers +2"/>
                      <a class="remove-entry" data-stage="stage4" data-module="{{modId}}" data-type="skills" data-entry="{{skillId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
                <div class="subpanel-column">
                  <div class="column-header">
                    <label>Traits</label>
                    <a class="add-entry" data-stage="stage4" data-module="{{modId}}" data-type="traits"><i class="fas fa-plus"></i></a>
                  </div>
                  <div class="column-entries">
                    {{#each mod.traits as |trait traitId|}}
                    <div class="entry-row" data-entry-id="{{traitId}}">
                      <input type="text" name="system.lifeStages.stage4.modules.{{modId}}.traits.{{traitId}}.value" value="{{trait.value}}" placeholder="e.g., Fast Learner"/>
                      <a class="remove-entry" data-stage="stage4" data-module="{{modId}}" data-type="traits" data-entry="{{traitId}}"><i class="fas fa-times"></i></a>
                    </div>
                    {{/each}}
                  </div>
                </div>
              </div>
            </div>
            {{else}}
            <div class="module-subpanel empty-module">
              <p class="empty-message">No modules added. Click + to add one.</p>
            </div>
            {{/each}}
          </div>
        </div>

        {{!-- Empty placeholder to maintain grid --}}
        <div class="life-stage-placeholder"></div>
      </div>

      {{!-- Other Notes / Biography --}}
      <div class="biography-section">
        <h3 class="section-title">Other Notes</h3>
        <div class="editor-container">
          {{editor system.biography target="system.biography" button=true owner=owner editable=editable}}
        </div>
      </div>
    </div>

  </section>
</form>
